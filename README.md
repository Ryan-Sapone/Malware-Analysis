# Malware-Analysis
Malware analysis lab: how to configure a virtualized environment to analyze malware as well as the process of downloading and running malware. This write-up will follow both LetsDefend's modules on static/dynamic malware analysis as well as TCM Security (Matt Husky's) Practical Malware Analysis & Triage course. 

<h1>Initial Lab Setup</h1>
Personally, I prefer using VMware Workstation over Virtual Box, but for this lab it's important to use Virtual Box due to SNAPSHOTS. This allows you to revert the virtual machine back in time, so once malware infects the virtual machine, you are able to revert back before it even happened. As with my other labs, I'm not going to go over how and where to download Windows ISO files or the step-by-step of setting up virtual machines. I will talk about the settings that I used on the initial Virtual Box setup to make sure that we can work as efficiently and safely as possible. Once your Windows 10 machine is installed and you're logged in, one of the first things to do is CREATE A SNAPSHOT of the base installation. God forbid something goes wrong or you install the wrong thing, at least you won't have to sit through the installation process again. I downloaded Google Chrome, installed it, and then made a snapshot of the base install.
<img src="https://user-images.githubusercontent.com/107446796/186524234-09d7b4cb-a1bd-4a2e-81b2-627a65c089d1.png">

Now we need to install FLARE-VM, which is a bunch of malware analysis tools (can be found here: https://github.com/mandiant/flare-vm). We are going to scroll down a bit to the Installation section, and right click on the "install.ps1" script to copy the link address. Open up PowerShell as an administrator. Below are the PowerShell commands we can run in order to download and install these tools on our Desktop. 
<img src="https://user-images.githubusercontent.com/107446796/186525199-ff432374-d716-44b2-815a-2b09ac4a202a.png">

```Set-ExecutionPolicy Unrestricted``` </br>
Type A for yes to all</br>
```wget https://github.com/fireeye/flare-vm/raw/master/install.ps1 -UseBasicParsing -outfile C:\Users\[YOUR_USERNAME_HERE]\Desktop\install.ps1```</br>
Be sure to change your username inside of your path</br>
```cd C:\Users\[YOUR_USERNAME_HERE]\Desktop\```</br>
Again, be sure to change your username</br>
```.\install.ps1```</br>
Enter your password and now you wait for about 4 hours for the installation. No, seriously - this took a few hours for me. I did have to press enter a few times after certain parts of the installation in order to continue, but just keep checking back every so often. 
<img src="https://user-images.githubusercontent.com/107446796/186527192-4cb406d8-d11b-4e80-b9c2-2f100e14ce8c.png">
<img src="https://user-images.githubusercontent.com/107446796/186539730-fc3ca460-0301-4bce-8b82-dd239362d1ed.png">

Once everything is done installing, your background should have been changed. Go ahead and restart, log back in, and CREATE YOUR SNAPSHOT.
<img src="https://user-images.githubusercontent.com/107446796/186544404-757caccd-ec3d-487e-af62-c565adfae5fe.png">

I know that I was thinking about the security of my actual, physical computer during this setup, and you should be too. With that in mind, we have to configure a private virtual network so that any malware we play with doesn't spread throughout our real network. Inside of Virtual Box, click on Tools and select Network. We are then going to create a new network. We are then going to check the box to enable DHCP, and change our network's classful address to something different than what we use on our home network. 
<img src="https://user-images.githubusercontent.com/107446796/186545274-1b23c04f-c8e9-4892-beff-ea30a7e9dbb5.png">
<img src="https://user-images.githubusercontent.com/107446796/186545416-4527b82a-7921-40d6-9d55-4265603ea9c7.png">

Now we'll go to the DHCP Server tab and identify the server as 10.0.0.2, add in our upper and lower ranges, and then apply. 
<img src="https://user-images.githubusercontent.com/107446796/186545631-c5b7146e-d087-4068-8287-9e5b8925d785.png">

We're going to go back to Virtual Box settings for our machine and change our adapter to HOST-ONLY ADAPTER instead of NAT or BRIDGED. Make sure you select the adapter name that you just created. Also verify that in the other tabs for adapter 2, 3, and 4, the checkbox to enable the adapter is UNCHECKED. 
<img src="https://user-images.githubusercontent.com/107446796/186546010-75da7b23-65aa-4f36-ae8e-ee4c9cc0df87.png">

You can verify everything is correct by running an ipconfig command, verifying you're on the 10.x.x.x network, and attempting to ping 8.8.8.8. With this virtual network setup, you should be unable to ping outside of the virtual network. 
<img src="https://user-images.githubusercontent.com/107446796/186546434-2bf6d0d0-ac06-416a-971c-ca5de606afd4.png">

<h1>REMnux Setup</h1>
REMnux is a Linux-based tookit for analyzing malware. The purpose behind setting this up is to look for network-based indicators of compromise within our segregated network. Navigate here (https://docs.remnux.org/install-distro/get-virtual-appliance) and let's download the OVA file.
<img src="https://user-images.githubusercontent.com/107446796/186761579-ea9fe2e8-d4bb-4e87-ace5-64bee5ebf705.png">

We are going to configure the same network adapter settings as we did with the Windows 10 machine - HOST-ONLY ADAPTER. 
<img src="https://user-images.githubusercontent.com/107446796/186764741-a8e641e5-6a06-48cd-b58a-4f2c011babfb.png">

You can verify network settings are correct by the ping test. In addition, you can have both your Windows 10 and REMnux VMs open at once, and make sure they can ping each other. 
<img src="https://user-images.githubusercontent.com/107446796/186765306-272c4966-f2b9-4379-90b0-343b05060543.png">

Now we're going to change some settings with INetSim, which will start some services on the REMnux machine such as HTTPS, FTP, and SMTPS, and acts like an internet simulator. In our terminal, let's open the configuration file by using: ```sudo nano /etc/inetsim/inetsim.conf```</br>
<img src="https://user-images.githubusercontent.com/107446796/186773747-cdd2290c-d1be-46d0-8ccf-faacb5aa87d5.png">

We are going to un-comment the "start_service dns" by removing the leading # symbol. Next, let's scroll down to the "service_bind_address" and un-comment it, and change the address to 0.0.0.0.
<img src="https://user-images.githubusercontent.com/107446796/186774291-b64d536c-8d58-4849-b629-e1030f1b2d98.png">

Let's scroll down some more under DNS Settings and find "dns_default_ip". We're going to un-comment this as well, and change the address to the IP address of the REMnux machine (in my case, 10.0.0.4). Go ahead and overwrite the file and exit. You can see that it worked by running ```inetsim``` in the terminal and seeing that the DNS service is started.
<img src="https://user-images.githubusercontent.com/107446796/186774676-f5a22ec1-9a0c-4a45-9ac2-0b4c79d35e09.png">
<img src="https://user-images.githubusercontent.com/107446796/186774982-2659b3e5-79d1-40a4-bd33-004c2fe09b0a.png">

One last thing to do now is to go back into our Windows 10 VM and configure the DNS settings. We want to change the default DNS server to that of our REMnux VM, so again in my case, it's 10.0.0.4. With INetSim running on our REMnux VM, we can open up a browser on our Windows 10 machine and navigate to any website, and it will show us the default INetSim page. On your REMnux machine, CREATE A SNAPSHOT so that you don't have to go back through the configurations again.
<img src="https://user-images.githubusercontent.com/107446796/186775893-5d26e80c-bb2d-4b77-b874-fe910dbc19a7.png">
<img src="https://user-images.githubusercontent.com/107446796/186775899-797f9fe9-4d70-43d0-aabe-01e61792c494.png">

Now, I went back to my Windows 10 VM and made sure to set it up with the GitHub repository with the malware samples, and then I CREATED A SNAPSHOT prior to detonation of my first malware sample. With all of this prep work out of the way, I (and hopefully you) now have a lab for malware analysis! Further folders in this repository will be used for my documentation of what I'm doing to identify, analyze, and triage the malware infections.











