<h1>Silly Putty Analysis</h1> 
This is the analysis for SillyPutty inside of Matt Husky's Practical Malware Analysis & Triage course. The goal of this challenge is to put some static and dynamic analysis tools and techniques to use and answer some questions about this potential malware. 

<h2>Static Analysis</h2>
<h3>Q1: What is the SHA256 hash of the sample?</h3>
To answer this, we have to simply hash the malware sample. In the terminal, we can type "sha256sum [FILE_NAME]" to get the SHA256 hash. We can also use "md5sum [FILE_NAME]" to get the MD5 hash as well. Let's save these as a note. 
<img src="https://user-images.githubusercontent.com/107446796/187083086-89a9bb1d-3d7a-4cc3-802e-da481005d9d1.png">
<img src="https://user-images.githubusercontent.com/107446796/187083093-20484102-7d5e-4f85-8722-b96016dcc0fb.png">

<h3>Q2: What architecture is this binary?</h3>
For this, we're going to use a tool called pestudio (available here: https://www.winitor.com). This is a tool that can help speed up the process of malware analysis, and you'll see in the screenshot below that it also gives you hashes of the file as well as the architecture. 
<img src="https://user-images.githubusercontent.com/107446796/187083738-5b6d0465-3875-42b7-bfb2-736a7740bbea.png">

<h3>Q3: Are there any results from submitting the SHA256 hash to VirusTotal??</h3>
This is an easy one - we should all (hopefully) be familiar with VirusTotal.
<img src="https://user-images.githubusercontent.com/107446796/187083838-e01108dd-4f92-46cd-a580-b5decb2436a0.png">

<h3>Q4: Describe the results of pulling the strings from this binary. Record and describe any strings that are potentially interesting. Can any interesting information be extracted from the strings?</h3>
We can use FLOSS to search for strings, or also look inside of pestudio as well. Inside of pestudio, you are able to sort the output and look for potential red flags of malware. Now for full disclosure, I was familiar with PuTTy as being a legitimate program, and going through some of the strings that were flagged or possibly suspicious, I thought that maybe this was a legitimate program, and that Matt was trying to trick us. When I went back to the walkthrough during this part, he did say that this section was meant to be difficult on purpose because PuTTy has certain API calls and edits to the registry that are part of the program itself. However, one of the things I did note down inside of my strings search was for HTTP requests and email addresses. By doing a Ctrl + F inside of the FLOSS output file, I noted one of the HTTP strings, but further investigation revealed it might just be a compiler and not a malicious request. 
<img src="https://user-images.githubusercontent.com/107446796/187084096-3b14c388-465e-4226-88ec-6b14894b90b9.png">
<img src="https://user-images.githubusercontent.com/107446796/187084847-77c164e0-9152-4b0b-95fe-6c864dc19086.png">
 
<h3>Q5: Describe the results of inspecting the IAT for this binary. Are there any imports worth noting?</h3>
I opened up the binary inside of PEview and looked at the Import Address Table. I then used a database for malicious API calls (https://malapi.io) and searched a few of them to try and get more information on what this binary might be trying to do. I had a little bit of luck in finding a few calls that could point to malicious activity. 
<img src="https://user-images.githubusercontent.com/107446796/187085776-be64456e-7850-46c4-b1b2-60c5bf8fa9dd.png">
<img src="https://user-images.githubusercontent.com/107446796/187085780-2d298861-665d-43fa-9e05-6130afd74a27.png">

<h3>Q6: Is it likely that this binary is packed?</h3>
By inspecting the virtual size and the raw data size and comparing the values, we can determine whether this binary is packed or unpacked. The calculations and comparison of both of these values is nearly identical, so we can accurately determine this is unlikely packed.
<img src="https://user-images.githubusercontent.com/107446796/187085957-8f4bace0-63f4-4bf8-b6b2-6e9f3de1e3e8.png">

<h2>Dynamic Analysis</h2>
<h3>Q1: Describe initial detonation. Are there any notable occurances at first detonation? Without internet simulation? With internet simulation?</h3>
We are going to do two detonations of this malware - the first without INetSim running on our REMnux machine, and the second while INetSim IS running. <br><br>

So the first time I ran the executable as administrator, there was a PowerShell screen that opened up in the background, which closed after about 3 seconds. There was also a folder created on my Desktop titled "PS_Transcripts", with a text file inside. Inspecting this text document, which seems to be logs of PowerShell commands, there are some arguments for "hidden" and "bypass" that I was immediately seeing. 
<img src="https://user-images.githubusercontent.com/107446796/187086326-9d945d4c-23ea-44b2-a28c-61c993e617dc.png"><br>

After resetting the VM and having INetSim and Wireshark started on my REMnux machine, I executed the potential malware again. The same PowerShell screen opened up and closed after a few seconds, and the log folder was put on my Desktop again. I then went over to my REMnux machine and took a look at the Wireshark capture, and one of the things I noticed was that my machine was maybe attempting to reach out to a "Windows Update" page in reference to disallowed certificates, and also some ".local" domain. Also, the user agent for this request was "Microsoft-CryptoAPI". 
<img src="https://user-images.githubusercontent.com/107446796/187086744-3deed880-87c6-47a7-9355-981b2e99f81e.png">
<img src="https://user-images.githubusercontent.com/107446796/187086758-2e12aaf5-c357-486c-9446-a8d15290e29a.png">

<h3>Q2: From the host-based indicators perspective, what is the main payload that is initiated at detonation? What tool can you use to identify this?</h3>
I know I jumped ahead a little bit. So for looking at host-based indicators, we can open up Procmon and see what processes are created upon execution of this program. When we filter by "Process Name" and add "putty.exe", you can see the PPID (parent process ID) that is given. From there, you can filter by that PPID as well and get the answer to this question.
<img src="https://user-images.githubusercontent.com/107446796/187087103-cb69c075-2233-4d9e-a26b-b9cf6f4a20cf.png">
<img src="https://user-images.githubusercontent.com/107446796/187087136-ce901b0f-a6e0-4674-9f77-cba89e008ec4.png">

<h3>Q3: What is the DNS record that is queried at detonation?</h3>
Back to our REMnux machine and Wireshark, we can see the attempted traffic on our network. One of these queries is unlike the other.
<img src="https://user-images.githubusercontent.com/107446796/187087313-4b644a1a-8960-4ece-970b-46be55ade1c1.png">

<h3>Q4: What is the callback port number at detonation?</h3>
Again, by looking at Wireshark we can determine which port is being utilized as a callback. We can see the three-way handshake starting and being sent to TCP port 8443. Matt's walkthrough also talks about using TCPView to find this information as well. 
<img src="https://user-images.githubusercontent.com/107446796/187087552-47e83369-ecdb-4eb3-acbf-e1e4beb19cf9.png">

<h3>Q5: What is the callback protocol at detonation?</h3>
Based on the indicators that we found so far, this PowerShell process seems to be reaching out to a remote port 8443 to this "bonus2...local" domain. This leads me to believe that this is some sort of reverse shell. I was a little stumped at properly identifying the callback protocol, however I wanted to assume it was HTTPS due to my Wireshark capture sending a lot of traffic on port 443. In order to verify, we'll follow Matt's guide to finding this information out. </br></br>

First thing to do is edit the hosts file and set our loopback as the "bonus2...local" in order to trick the reverse shell into having a domain to connect back to. We're also going to establish a netcat listener on port 8443. Let's do that and also spin up Wireshark on this machine to see the traffic from our virtual NIC.

<img src="https://user-images.githubusercontent.com/107446796/187088260-006bbe27-7a41-4b2e-afb3-2d3c27d72eb4.png">
<img src="https://user-images.githubusercontent.com/107446796/187088866-c68c05ef-803a-496b-b898-71f2ad7f33b1.png">

After doing this, we can see in the Wireshark output that we have a TLS/Client Hello, which is how encrypted communication gets established.
<img src="https://user-images.githubusercontent.com/107446796/187088968-bb44b6cb-ab13-4795-89dc-c3323712b9b1.png">

<h3>Q6: How can you use host-based telemetry to identify the DNS record, port, and protocol?</h3>
Based on the above information, we have identified the DNS record, port, and protocols being used for this malware. We have utilized tools like TCPView (or Wireshark) and procmon to view the actual PowerShell script itself. 

<h3>Q7: Attempt to get the binary to initiate a shell on the localhost. Does a shell spawn? What is needed for a shell to spawn?</h3>
Again based on the above information gathered (and some further understanding from the walkthrough), a connection is not established. Due to the TLS handshake not being able to be finished, any connection is terminated when trying to run any commands. 
<img src="https://user-images.githubusercontent.com/107446796/187089290-cb5f8c6b-a9a9-425c-919b-6425884976a2.png">

<h3>Overall Personal Score: 7/10</h3>
I think overall I did pretty well at the static analysis, but I may have spent too much time actually trying to look for interesting strings. Being that this malware utilizes PuTTy, it makes sense that there are some strings and API calls that are potentially flagged as suspicious. During the dynamic analysis, I was not able to determine that the PowerShell script was a one-liner encoded with base64, so I didn't go into as much detail as I maybe should have. In addition, I had a little bit of trouble remembering the trick to edit our hosts file in order to attempt a connection for a shell. This challenge was quite fun and it was a great first taste at malware analysis on my own without my hand really being held.
